name: Continuous Deployment

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Ansible Docker image
      run: |
        cd ansible
        docker build -t ansible-runner:latest .
        
    - name: Decrypt SSH key from Vault
      run: |
        cd ansible
        echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > /tmp/vault_pass
        docker run --rm \
          -v $(pwd):/ansible \
          -v /tmp/vault_pass:/tmp/vault_pass:ro \
          ansible-runner:latest \
          sh -c "ansible-vault decrypt --vault-password-file /tmp/vault_pass vault/secrets.yml && \
                 grep -A 1000 'ssh_private_key:' vault/secrets.yml | tail -n +2 | \
                 sed '1d' | sed '1d' > /tmp/id_rsa && \
                 chmod 600 /tmp/id_rsa"
      continue-on-error: true
      
    - name: Deploy backend with Ansible Docker container
      run: |
        cd ansible
        echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > /tmp/vault_pass
        docker run --rm \
          -v $(pwd):/ansible \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /tmp/vault_pass:/tmp/vault_pass:ro \
          ansible-runner:latest \
          sh -c "if [ -f /tmp/id_rsa ]; then \
                   SSH_KEY=/tmp/id_rsa; \
                 else \
                   echo '${{ secrets.SSH_PRIVATE_KEY }}' > /tmp/id_rsa && \
                   chmod 600 /tmp/id_rsa && \
                   SSH_KEY=/tmp/id_rsa; \
                 fi && \
                 ansible-playbook -i inventories/setup.yml restart-backend.yml \
                   --extra-vars 'ansible_ssh_private_key_file=\$SSH_KEY' \
                   --extra-vars 'ansible_host_key_checking=False'"
        
    - name: Verify deployment
      run: |
        sleep 30
        curl -f http://ruben.bensais--rueda.takima.cloud/actuator/health || exit 1
        echo "âœ… Backend restarted successfully!"