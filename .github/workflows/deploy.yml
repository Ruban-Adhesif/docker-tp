name: Continuous Deployment

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Ansible
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible
        
    - name: Install Ansible collections
      run: |
        ansible-galaxy collection install community.docker
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ruben.bensais--rueda.takima.cloud >> ~/.ssh/known_hosts
        
    - name: Deploy with Ansible
      run: |
        cd ansible
        ansible-playbook -i inventories/setup.yml playbook.yml --extra-vars "ansible_ssh_private_key_file=~/.ssh/id_rsa"
      env:
        ANSIBLE_HOST_KEY_CHECKING: False
        
    - name: Wait for deployment
      run: sleep 60
        
    - name: Verify API health
      run: |
        curl -f http://ruben.bensais--rueda.takima.cloud/actuator/health
        echo "âœ… Health check passed!"
        
    - name: Test API endpoints
      run: |
        echo "Testing main endpoint..."
        curl -f http://ruben.bensais--rueda.takima.cloud/ | jq .
        echo "Testing students endpoint..."
        curl -f http://ruben.bensais--rueda.takima.cloud/students | jq .
        echo "Testing departments endpoint..."
        curl -f http://ruben.bensais--rueda.takima.cloud/departments | jq .
        
    - name: Deployment success
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ API URL: http://ruben.bensais--rueda.takima.cloud"
        echo "ğŸ“Š Students: http://ruben.bensais--rueda.takima.cloud/students"
        echo "ğŸ¢ Departments: http://ruben.bensais--rueda.takima.cloud/departments"